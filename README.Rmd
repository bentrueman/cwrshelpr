---
output: github_document
---

<!-- README.md is generated from README.Rmd. Please edit that file -->

```{r, include = FALSE}
knitr::opts_chunk$set( 
  collapse = TRUE,
  comment = "#>",
  fig.path = "man/figures/README-",
  out.width = "100%",
  dev = "png",
  dpi = 600
) 
```

# cwrshelpr

<!-- badges: start -->
<!-- badges: end -->

`cwrshelpr` provides a collection of functions for data analysis tasks at Dalhousie University's Centre for Water Resources Studies.

## Installation

You can install the development version from [GitHub](https://github.com/) with:

``` r
# install.packages("remotes")
remotes::install_github("bentrueman/cwrshelpr")
```
## Read and clean ICP-MS data

To read and clean ICP-MS data files generated by the Thermo Scientific iCAP-RQ, use the `read_icp()` function. (N.B., the code below uses external raw data files as examples; replace them with your data.)

```{r read-icp, message=FALSE}
library("tidyverse")
library("cwrshelpr")
# example path to example raw data file
files <- list.files(
   path = system.file("extdata", package = "cwrshelpr"), # replace this line with the path to your data
   full.names = TRUE,
   pattern = ".+\\.xlsx"
)
read_icp(path = files[1]) # read and clean one file
files %>% 
  set_names() %>% 
  map_dfr(read_icp, .id = "file") # read and clean multiple files

```

```{r theme, echo=FALSE}
theme_set(theme_bw())
```

## Read and clean FEEM data

To read and clean FEEM data files generated by the Horiba Aqualog, use the `read_feem()` function. The argument `truncate = TRUE` may be useful if the corrected first order Rayleigh scattering line includes negative intensities.

```{r read-feem, message=FALSE}

files <- list.files(
   path = system.file("extdata", package = "cwrshelpr"), # replace this line with the path to your data
   full.names = TRUE,
   pattern = ".+\\.csv"
)
read_feem(path = files[1]) # read and clean one file
feem_dat <- files %>% 
  set_names() %>% 
  map_dfr(~ read_feem(.x, truncate = TRUE), .id = "file") # read and clean multiple files

```

Plot FEEM data using the function `ggplot2::geom_raster()` (among others). Use the column `em_regular` to avoid horizontal striping due to irregular spacing of the `emission` wavelengths.

```{r feem-plot, fig.height=3.5}

feem_dat %>% 
  ggplot(aes(excitation, em_regular, fill = intensity)) +
  facet_wrap(vars(file)) + 
  geom_raster() + 
  scale_fill_viridis_c()

```

Here is an example using `ggplot2::stat_contour(geom = "polygon")`:

```{r feem-plot-2, fig.height=3.5}

feem_dat %>% 
  ggplot(aes(excitation, em_regular, z = intensity, fill = stat(level))) +
  facet_wrap(vars(file)) + 
  stat_contour(geom = "polygon") +
  scale_fill_viridis_c("intensity")

```

Integrate regions of the FEEM using `integrate_regions()`. This function uses the regions defined in Chen et al. (2003) by default, but you can supply your own as well.

```{r inegrate}

feem_dat %>% 
  group_by(file) %>% 
  nest() %>% 
  ungroup() %>% 
  mutate(regions = map(data, integrate_regions)) %>% 
  unnest(regions)

```

# References  

Chen, W., Westerhoff, P., Leenheer, J. A., & Booksh, K. (2003). Fluorescence excitationâˆ’emission matrix regional integration to quantify spectra for dissolved organic matter. Environmental science & technology, 37(24), 5701-5710.
